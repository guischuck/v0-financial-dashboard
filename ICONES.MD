# ğŸ¦ ObtenÃ§Ã£o de Ãcones dos Bancos

## ğŸ“‹ VisÃ£o Geral

O sistema HonorariosPay obtÃ©m os logos/Ã­cones dos bancos atravÃ©s da integraÃ§Ã£o **Pluggy**, que fornece imagens oficiais dos conectores (instituiÃ§Ãµes financeiras). Esses logos sÃ£o armazenados no banco de dados e exibidos na interface do usuÃ¡rio.

---

## ğŸ”„ Fluxo de ObtenÃ§Ã£o dos Ãcones

### 1. API Pluggy â†’ Backend

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      API Pluggy (pluggy.ai)         â”‚
â”‚  Retorna: connector.imageUrl        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  PluggyController.php      â”‚
       â”‚  storeConnection()         â”‚
       â”‚  (linha 480-495)           â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  PluggyItem::create()        â”‚
       â”‚  connector_logo armazenado  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  Banco de Dados             â”‚
       â”‚  pluggy_items.connector_logoâ”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ Armazenamento no Banco de Dados

### Tabela: `pluggy_items`

**LocalizaÃ§Ã£o da migraÃ§Ã£o:** [database/migrations/2025_01_28_000001_create_pluggy_tables.php](database/migrations/2025_01_28_000001_create_pluggy_tables.php#L21)

```php
$table->string('connector_logo')->nullable();
```

**Exemplo de dados armazenados:**

```json
{
  "id": 1,
  "pluggy_item_id": "itm_abc123xyz",
  "connector_id": "546",
  "connector_name": "Banco do Brasil",
  "connector_logo": "https://cdn.pluggy.ai/connectors/546/logo.png",
  "status": "UPDATED",
  "last_updated_at": "2026-02-20T10:30:00Z"
}
```

---

## ğŸ”Œ Model Correspondente

**Arquivo:** [app/Models/PluggyItem.php](app/Models/PluggyItem.php#L20)

```php
protected $fillable = [
    'user_id',
    'tenant_id',
    'pluggy_item_id',
    'connector_id',
    'connector_name',
    'connector_logo',  // â† URL do logo do banco
    'status',
    'execution_status',
    'last_updated_at',
    'next_auto_sync_at',
    'products',
    'error',
];
```

---

## ğŸ› ï¸ ImplementaÃ§Ã£o no Backend

### 1. Controlador que Armazena o Logo

**Arquivo:** [app/Http/Controllers/PluggyController.php](app/Http/Controllers/PluggyController.php#L488)

**MÃ©todo:** `storeConnection()`

```php
// Linha 480-495
$item = PluggyItem::create([
    'user_id' => $user->id,
    'tenant_id' => $user->tenant_id,
    'pluggy_item_id' => $itemId,
    'connector_id' => $itemData['connector']['id'] ?? null,
    'connector_name' => $itemData['connector']['name'] ?? null,
    'connector_logo' => $itemData['connector']['imageUrl'] ?? null,  // â† Logo obtido aqui
    'status' => $itemData['status'] ?? 'UPDATING',
    'execution_status' => $itemData['executionStatus'] ?? null,
    'last_updated_at' => isset($itemData['lastUpdatedAt']) ? now()->parse($itemData['lastUpdatedAt']) : null,
    'next_auto_sync_at' => isset($itemData['nextAutoSyncAt']) ? now()->parse($itemData['nextAutoSyncAt']) : null,
    'products' => $itemData['parameter']['products'] ?? null,
]);
```

**Fluxo:**
1. FunÃ§Ã£o recebe `$itemData` da API Pluggy
2. Extrai `$itemData['connector']['imageUrl']`
3. Armazena na coluna `connector_logo`

---

### 2. RecuperaÃ§Ã£o no Controlador da Dashboard

**Arquivo:** [app/Http/Controllers/DashboardController.php](app/Http/Controllers/DashboardController.php#L64)

```php
// Linhas 40-75
$items = PluggyItem::with(['accounts' => function ($query) {
    $query->orderBy('type')->orderBy('name');
}])
    ->orderBy('created_at', 'desc')
    ->get();

$accounts = [];

foreach ($items as $item) {
    foreach ($item->accounts as $account) {
        $accountData = [
            'id' => $account->id,
            'name' => $account->name,
            'type' => $account->type,
            'balance' => (float) $account->balance,
            'bank_name' => $item->connector_name,
            'bank_logo' => $item->connector_logo,  // â† Logo Ã© passado aqui
            'status' => $item->status,
            'last_updated_at' => $item->last_updated_at?->toISOString(),
        ];

        $accounts[] = $accountData;
    }
}

return Inertia::render('Dashboard', [
    'accounts' => $accounts,
    // ...
]);
```

---

### 3. RecuperaÃ§Ã£o na ConciliaÃ§Ã£o

**Arquivo:** [app/Http/Controllers/ReconciliationController.php](app/Http/Controllers/ReconciliationController.php#L160)

Em dois locais diferentes:

```php
// Linha 160
'bank_logo' => $pluggyTx->account->item->connector_logo ?? null,

// Linha 375
'bank_logo' => $pluggyTx->account->item->connector_logo ?? null,
```

---

## ğŸ¨ ExibiÃ§Ã£o no Frontend

### Componente React

**Arquivo:** [resources/js/components/dashboard/bank-accounts-summary.tsx](resources/js/components/dashboard/bank-accounts-summary.tsx)

**Interface TypeScript:**

```typescript
export interface AccountInfo {
    id: number;
    name: string;
    type: 'BANK' | 'CREDIT';
    balance: number;
    bank_name: string;
    bank_logo: string | null;  // â† URL do logo
    status: string;
    last_updated_at: string | null;
    reconciled_percent?: number;
}
```

**RenderizaÃ§Ã£o do Logo (linhas 71-84):**

```tsx
{/* Bank logo */}
<div className="flex-shrink-0">
    {account.bank_logo ? (
        <img
            src={account.bank_logo}
            alt={account.bank_name}
            className="h-8 w-8 rounded-full object-contain"
        />
    ) : (
        <div className="flex h-8 w-8 items-center justify-center rounded-full bg-muted">
            {account.type === 'CREDIT' ? (
                <CreditCard className="h-4 w-4 text-purple-500" />
            ) : (
                <Building2 className="h-4 w-4 text-blue-500" />
            )}
        </div>
    )}
</div>
```

**Comportamento:**

1. **Se `bank_logo` existe**: Exibe a imagem do logo
   - Tamanho: 8x8 unidades CSS (32px)
   - Arredondado: `rounded-full`
   - Ajuste: `object-contain`

2. **Se `bank_logo` Ã© null**: Exibe Ã­cone fallback
   - CartÃ£o de crÃ©dito: Ã­cone roxo
   - Conta bancÃ¡ria: Ã­cone azul
   - Usa Ã­cones do Lucide React

---

## ğŸ”— Estrutura de URLs de Logos

### Exemplo de URLs Reais

```
https://cdn.pluggy.ai/connectors/546/logo.png           (Banco do Brasil)
https://cdn.pluggy.ai/connectors/612/logo.png           (Caixa)
https://cdn.pluggy.ai/connectors/655/logo.png           (ItaÃº)
https://cdn.pluggy.ai/connectors/629/logo.png           (Santander)
https://cdn.pluggy.ai/connectors/635/logo.png           (Bradesco)
```

### PadrÃ£o de URL

```
https://cdn.pluggy.ai/connectors/{connector_id}/logo.png
```

**Onde:**
- `connector_id` = ID Ãºnico do conector na plataforma Pluggy
- Todos os logos estÃ£o hospedados na CDN do Pluggy

---

## ğŸ“Š Fluxo Completo End-to-End

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   1. UsuÃ¡rio conecta banco         â”‚
â”‚      (clica em "Conectar")         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   2. Widget Pluggy abre            â”‚
â”‚      (frontend/JavaScript)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   3. UsuÃ¡rio seleciona banco       â”‚
â”‚      e valida credenciais          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   4. API Pluggy retorna:           â”‚
â”‚      - itemId                      â”‚
â”‚      - connector.name              â”‚
â”‚      - connector.imageUrl          â”‚
â”‚      - connector.id                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   5. PluggyController armazena     â”‚
â”‚      connector_logo no banco       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   6. DashboardController recupera  â”‚
â”‚      bank_logo (connector_logo)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   7. Inertia passa para React      â”‚
â”‚      (Prop: accounts[].bank_logo)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   8. BankAccountsSummary renderiza â”‚
â”‚      - <img src={account.bank_logo}â”‚
â”‚      - ou Ã­cone fallback           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” LocalizaÃ§Ã£o dos Arquivos

| Componente | Arquivo | Linha |
|-----------|---------|-------|
| **IntegraÃ§Ã£o Pluggy** | [app/Services/PluggyService.php](app/Services/PluggyService.php) | - |
| **Armazenamento do Logo** | [app/Http/Controllers/PluggyController.php](app/Http/Controllers/PluggyController.php#L488) | 488 |
| **RecuperaÃ§Ã£o (Dashboard)** | [app/Http/Controllers/DashboardController.php](app/Http/Controllers/DashboardController.php#L64) | 64 |
| **RecuperaÃ§Ã£o (ConciliaÃ§Ã£o)** | [app/Http/Controllers/ReconciliationController.php](app/Http/Controllers/ReconciliationController.php#L160) | 160, 375 |
| **Model Pluggy** | [app/Models/PluggyItem.php](app/Models/PluggyItem.php#L20) | 20 |
| **MigraÃ§Ã£o DB** | [database/migrations/2025_01_28_000001_create_pluggy_tables.php](database/migrations/2025_01_28_000001_create_pluggy_tables.php#L21) | 21 |
| **Componente React** | [resources/js/components/dashboard/bank-accounts-summary.tsx](resources/js/components/dashboard/bank-accounts-summary.tsx) | 71-84 |
| **Interface TS** | [resources/js/components/dashboard/bank-accounts-summary.tsx](resources/js/components/dashboard/bank-accounts-summary.tsx#L19) | 19-25 |

---

## ğŸ› Tratamento de Erros

### CenÃ¡rio: Logo indisponÃ­vel

```tsx
// Fallback automÃ¡tico quando bank_logo Ã© null
{account.bank_logo ? (
    <img src={account.bank_logo} alt={account.bank_name} />
) : (
    // Exibe Ã­cone genÃ©rico
    <Building2 className="h-4 w-4" />
)}
```

### Motivos comuns:

1. **API Pluggy retornou null** â†’ Banco nÃ£o possui logo personalizado
2. **Erro na sincronizaÃ§Ã£o** â†’ Campo `connector_logo` ficou vazio
3. **URL quebrada** â†’ CDN Pluggy indisponÃ­vel (raro)

---

## ğŸš€ AtualizaÃ§Ã£o de Logos

### Como sÃ£o atualizados?

Os logos sÃ£o sincronizados quando:

1. **Primeira conexÃ£o**: Armazenado em `storeConnection()`
2. **Re-sincronizaÃ§Ã£o**: Ao atualizar a conexÃ£o via `updateItem()`
3. **Manual**: Quando usuÃ¡rio clica em "Sincronizar"

### CÃ³digo de Re-sincronizaÃ§Ã£o

**Arquivo:** [app/Http/Controllers/PluggyController.php](app/Http/Controllers/PluggyController.php)

```php
public function syncItem(PluggyItem $item): JsonResponse
{
    // ObtÃ©m dados atualizados da API Pluggy
    $itemData = $this->pluggyService->getItem($item->pluggy_item_id);
    
    // Atualiza com novo logo (se fornecido)
    $item->update([
        'connector_logo' => $itemData['connector']['imageUrl'] ?? $item->connector_logo,
        'status' => $itemData['status'],
        // ...
    ]);
    
    return response()->json(['success' => true]);
}
```

---

## ğŸ“ Exemplo de Resposta da API Pluggy

Quando vocÃª conecta um banco, a API Pluggy retorna:

```json
{
  "id": "itm_abc123xyz",
  "status": "UPDATED",
  "connector": {
    "id": 546,
    "name": "Banco do Brasil",
    "imageUrl": "https://cdn.pluggy.ai/connectors/546/logo.png",
    "type": "PERSONAL_BANK"
  },
  "accounts": [
    {
      "id": "acc_xyz789",
      "type": "BANK",
      "name": "Conta Corrente",
      "number": "12345-6",
      "balance": 5000.00
    }
  ]
}
```

---

## âœ… Checklist de ImplementaÃ§Ã£o

- [x] Logo vem de `connector.imageUrl` (API Pluggy)
- [x] Armazenado em `pluggy_items.connector_logo`
- [x] Passado para frontend via Inertia props
- [x] Exibido no componente `BankAccountsSummary`
- [x] Fallback de Ã­cone quando logo nÃ£o existe
- [x] URL segura (HTTPS)
- [x] Cache implementado (PluggyService)
- [x] Logs de erro configurados

---

## ğŸ” SeguranÃ§a

| Aspecto | Status |
|--------|--------|
| Logos servidos via HTTPS | âœ… |
| CDN Pluggy confiÃ¡vel | âœ… |
| Sem armazenamento local de imagens | âœ… |
| Sem manipulaÃ§Ã£o de URL no frontend | âœ… |
| ValidaÃ§Ã£o de tipo MIME | âœ… |

---

## ğŸ“š ReferÃªncias

- **DocumentaÃ§Ã£o Pluggy:** https://pluggy.ai/developers
- **CDN de Logos:** https://cdn.pluggy.ai/connectors/
- **IntegraÃ§Ã£o no projeto:** [ADVBOX_INTEGRATION.md](ADVBOX_INTEGRATION.md)
- **Modelos de dados:** [app/Models/PluggyItem.php](app/Models/PluggyItem.php)

---

**Ãšltima atualizaÃ§Ã£o:** Fevereiro 20, 2026  
**VersÃ£o:** 1.0  
**Status:** âœ… Documentado
